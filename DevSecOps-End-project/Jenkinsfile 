pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Build and Run Docker Container') {
            matrix {
                axes {
                    axis {
                        name 'BRANCH'
                        values 'branch1', 'branch2', 'branch3'
                    }
                }
                stages {
                    stage('Build') {
                        steps {
                            script {
                                // Build Docker container from Dockerfile
                                sh 'docker build -t my-container:${BRANCH} .'
                            }
                        }
                    }

                    stage('Run and Check') {
                        steps {
                            script {
                                // Run Docker container
                                sh 'docker run -d -p 8080:8080 my-container:${BRANCH}'

                                // Wait for the container to start
                                sleep 30

                                // Check if the application is running
                                def curlStatus = sh(script: 'curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080', returnStatus: true)
                                echo "Curl Status: ${curlStatus}"

                                // Cleanup
                                sh 'docker stop $(docker ps -q)'
                                sh 'docker rm $(docker ps -a -q)'
                            }
                        }
                    }
                }
            }
        }
    }
}
